{% extends "layout.html" %}
{% block body %}

<section>
    {% if timeline == None %}

    <h1>There was an issue generating your question</h1>
    <h2>Sorry for the inconvenience.</h2>
    <p>Please return to the <a href="/">homepage</a> to start again.</p>

    {% else %}
    <h1>Question {{ question }}</h1>
    <p>In this question, please select the Tweet(s) from the timeline that you find interesting.</p>
    <p>Please select <strong>at least one</strong> Tweet from the timeline. There is no upper limit.</p>

    <h2>Timeline Description</h2>
    <p>{{ description }}</p>
        
    <div id="timeline">

    {% autoescape false %}
    {% for tweet in timeline.tweets %}
        <article data-id="{{tweet.id}}" data-user="{{tweet.user.id}}"
        {% if tweet.selected == 1 %}
        class="selected"
        {% endif %}
        >
            <img src="{{ tweet.user.profile_image }}" class="profile-image" />
            <p class="screen-name">@{{ tweet.user.screen_name}}
                <span class="name">{{ tweet.user.name }}</span></p>
            <p class="text">{{ tweet.getDisplayText() }}</p>
            <p class="info"><label>Retweeted</label>{{ tweet.retweet_count }}</p>
            <div style="clear:both"></div>
        </article>
    {% endfor %}
    {% endautoescape %}
    </div>

    {% if question < 5 %}
        <button class="previous">Previous</button>
    {% endif %}
    {% if question < 5 %}
        <button class="next">Next</button>
    {% endif %}

    {% endif %}

</section> 

<aside>
    <h3>Help</h3>
    <ul>
        <li>To select a Tweet, simply click it.</li>
        <li>To unselect a Tweet, click it again.</li>
        <li>When satisfied, click the 'Next' button at the bottom to move to the next question.</li>
        <li>Your responses will be saved when you click the 'Next' button.</li>
    </ul>
</aside>
<aside>
    <h3>Question navigation</h3>
    <p><span id="num_tweets">0</span> Tweets selected</p>
    <button class="previous">prev</button><button class="next">next</button>
</aside>
{% endblock %}

{% block scripts %}
var selectedTweets = new Array();
var selectedUsers = new Array();

function calculateArray(){
    selectedArray = new Array();
    selectedUsers = new Array();
    var counter = 0;
    $("article").each(function(){
        if($(this).hasClass("selected")){
            selectedTweets[counter] = $(this).attr("data-id");
            selectedUsers[counter] = $(this).attr("data-user");
            counter ++;
            $(this).css({'background':'rgba(0,0,0,0.1)'});
        }
        else{
            $(this).css({'background':'none'});   
        }
    });
    $("#num_tweets").html(counter);
}

function submitResponse(next_question){
    var arrays = getArraysForPosting();
    tweet_ids = arrays[0].join(",");
    selected = arrays[1].join(",");

    $.ajax({
        type : 'POST',
        url : '/api/update-question/{{ question }}/',
        dataType : 'json',
        data : {
            tweet_ids: tweet_ids,
            selected: selected
        },
        success : function(data){
            if(data.error == 0){
                window.location = "/question/"+next_question;
            }
            else{
                alert(data.info+"\nPlease contact me!");
            }
        },
        error : function(XMLHttpRequest, textStatus, errorThrown){
            console.log(textStatus+": "+errorThrown);
        }
    });
}

function getArraysForPosting(){
    var tweets = new Array();
    var selected = new Array();
    var counter = 0;

    $("article").each(function(){
        tweets[counter] = $(this).attr("data-id");
        if($(this).hasClass("selected")){
            selected[counter] = 1;
        }
        else{
            selected[counter] = 0;
        }
        counter ++;
    });
    return [tweets, selected];
}

$(document).ready(function(){
    $("article").click(function(){
        if($(this).hasClass("selected")){
            $(this).removeClass("selected");
        }
        else{
            $(this).addClass("selected");
        }
        calculateArray();
    });

    $(".next").click(function(){
        var next_question = {{ question }} + 1;
        submitResponse(next_question);        
    });

    $(".previous").click(function(){
        var next_question = {{ question }} - 1;
        submitResponse(next_question);        
    });
    calculateArray();    

});

{% endblock %}
